name: ğŸš€ Deploy Rocket.Chat to AKS

on:
  push:
    branches: [main, develop]
    paths:
      - 'aks/**'
      - 'k8s/**'
      - 'infrastructure/**'
      - '.github/workflows/deploy-aks.yml'
  pull_request:
    branches: [main]
    paths:
      - 'aks/**'
      - 'k8s/**'
      - 'infrastructure/**'

env:
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  CLUSTER_NAME: ${{ secrets.CLUSTER_NAME }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}

jobs:
  # Pre-deployment checks and validation
  validate:
    name: ğŸ” Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check for Changes
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "ğŸ” Pull request detected - validation only"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸš€ Main branch - deployment enabled"
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "ğŸ” Other branch - validation only"
          fi

      - name: ğŸ“‹ Validate YAML Files
        run: |
          echo "ğŸ” Validating Kubernetes manifests..."
          find . -name "*.yaml" -o -name "*.yml" | while read file; do
            if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
              echo "âŒ Invalid YAML in $file"
              exit 1
            fi
          done
          echo "âœ… All YAML files are valid"

      - name: ğŸ”§ Validate Helm Charts
        run: |
          echo "ğŸ” Validating Helm charts..."
          if command -v helm &> /dev/null; then
            helm lint aks/config/helm-values/values-official.yaml || true
            helm lint aks/config/helm-values/monitoring-values.yaml || true
          else
            echo "âš ï¸ Helm not available for validation"
          fi

  # Deploy to AKS
  deploy:
    name: ğŸš€ Deploy to AKS
    needs: validate
    if: needs.validate.outputs.should-deploy == 'true'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: ğŸ—ï¸ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: ğŸ—ï¸ Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: ğŸ”— Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.CLUSTER_NAME }} \
            --overwrite-existing

      - name: ğŸ” Pre-deployment Health Check
        run: |
          echo "ğŸ” Checking cluster health..."
          kubectl get nodes
          kubectl get pods -A
          echo "âœ… Cluster is accessible"

      - name: ğŸš€ Deploy Rocket.Chat
        run: |
          echo "ğŸš€ Starting Rocket.Chat deployment..."
          cd aks/deployment
          chmod +x deploy-aks-official.sh
          ./deploy-aks-official.sh

      - name: ğŸ“Š Deploy Monitoring Stack
        run: |
          echo "ğŸ“Š Deploying monitoring stack..."
          cd aks/scripts
          chmod +x deploy-enhanced-monitoring.sh
          ./deploy-enhanced-monitoring.sh

      - name: ğŸ” Post-deployment Verification
        run: |
          echo "ğŸ” Verifying deployment..."
          kubectl get pods -n rocketchat
          kubectl get pods -n monitoring
          
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=rocketchat -n rocketchat --timeout=300s
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=prometheus -n monitoring --timeout=300s
          
          echo "âœ… Deployment verification completed"

      - name: ğŸ§ª Run Health Checks
        run: |
          echo "ğŸ§ª Running health checks..."
          if [ -f "scripts/health-check.sh" ]; then
            chmod +x scripts/health-check.sh
            ./scripts/health-check.sh
          else
            echo "âš ï¸ Health check script not found"
          fi

      - name: ğŸ“Š Generate Deployment Report
        run: |
          echo "ğŸ“Š Generating deployment report..."
          cat << EOF > deployment-report.md
          # ğŸš€ Deployment Report
          
          **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Commit**: ${{ github.sha }}
          **Branch**: ${{ github.ref_name }}
          **Actor**: ${{ github.actor }}
          
          ## ğŸ¯ Deployment Status
          - âœ… Rocket.Chat deployed successfully
          - âœ… Monitoring stack deployed
          - âœ… Health checks passed
          
          ## ğŸ“Š Cluster Status
          \`\`\`
          $(kubectl get nodes)
          \`\`\`
          
          ## ğŸš€ Rocket.Chat Pods
          \`\`\`
          $(kubectl get pods -n rocketchat)
          \`\`\`
          
          ## ğŸ“Š Monitoring Pods
          \`\`\`
          $(kubectl get pods -n monitoring)
          \`\`\`
          
          ## ğŸ”— Access Information
          - **Rocket.Chat**: https://chat.canepro.me
          - **Grafana**: https://grafana.chat.canepro.me
          - **Port Forward**: \`kubectl port-forward svc/monitoring-grafana 3000:80 -n monitoring\`
          EOF

      - name: ğŸ“¤ Upload Deployment Report
        uses: actions/upload-artifact@v3
        with:
          name: deployment-report
          path: deployment-report.md

  # Security and compliance checks
  security:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Scan for Secrets
        run: |
          echo "ğŸ” Scanning for potential secrets..."
          if command -v gitleaks &> /dev/null; then
            gitleaks detect --source . --verbose
          else
            echo "âš ï¸ Gitleaks not available - manual secret check recommended"
            # Basic secret patterns check
            grep -r -i "password\|secret\|key\|token" --include="*.yaml" --include="*.yml" . | grep -v "example\|template\|placeholder" || true
          fi

      - name: ğŸ” Kubernetes Security Scan
        run: |
          echo "ğŸ” Running Kubernetes security checks..."
          if command -v kube-score &> /dev/null; then
            find . -name "*.yaml" -o -name "*.yml" | while read file; do
              kube-score score "$file" || true
            done
          else
            echo "âš ï¸ kube-score not available - manual security review recommended"
          fi

  # Cost monitoring and optimization
  cost-monitoring:
    name: ğŸ’° Cost Monitoring
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: ğŸ’° Check Resource Costs
        run: |
          echo "ğŸ’° Checking resource costs..."
          if [ -f "aks/scripts/cost-monitoring.sh" ]; then
            chmod +x aks/scripts/cost-monitoring.sh
            ./aks/scripts/cost-monitoring.sh
          else
            echo "âš ï¸ Cost monitoring script not found"
          fi

      - name: ğŸ“Š Generate Cost Report
        run: |
          echo "ğŸ“Š Generating cost report..."
          az consumption usage list \
            --start-date $(date -d '1 month ago' +%Y-%m-%d) \
            --end-date $(date +%Y-%m-%d) \
            --output table || echo "âš ï¸ Cost data not available"
